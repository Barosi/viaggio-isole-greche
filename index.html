<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Viaggio Isole Greche 2024 - Mykonos, Paros, Naxos</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Arial', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: rgba(255, 255, 255, 0.95); border-radius: 20px; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1); overflow: hidden; }
        .header { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .header p { font-size: 1.2em; }
        
        /* STATUS BAR */
        .status-bar { position: fixed; top: 20px; right: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 10px; }
        .connection-status { background: rgba(40, 167, 69, 0.9); color: white; padding: 10px 15px; border-radius: 20px; font-size: 0.9em; transition: all 0.3s ease; }
        .connection-status.saving { background: rgba(255, 193, 7, 0.9); }
        .connection-status.offline { background: rgba(220, 53, 69, 0.9); }
        .online-users { background: rgba(33, 150, 243, 0.9); color: white; padding: 8px 12px; border-radius: 15px; font-size: 0.8em; min-width: 150px; }
        .online-users h4 { margin-bottom: 5px; font-size: 0.9em; }
        .user-list { display: flex; flex-wrap: wrap; gap: 5px; }
        .user-badge { background: rgba(255, 255, 255, 0.2); padding: 2px 8px; border-radius: 10px; font-size: 0.8em; }
        
        /* BUDGET SECTION */
        .budget-section { padding: 40px; background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); margin: 20px; border-radius: 15px; }
        .budget-title { text-align: center; font-size: 2em; color: #8b4513; margin-bottom: 30px; }
        .budget-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .budget-item { background: white; padding: 25px; border-radius: 15px; border-left: 6px solid #ff6b6b; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .budget-item h3 { color: #333; font-size: 1.2em; margin-bottom: 15px; }
        .budget-item input[type="number"] { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1.3em; font-weight: bold; color: #ff6b6b; }
        .budget-item input[type="number"]:focus { border-color: #ff6b6b; outline: none; }
        .total-cost { background: #333; color: white; padding: 25px; border-radius: 15px; text-align: center; margin-top: 30px; font-size: 1.5em; font-weight: bold; }
        
        /* WEATHER WIDGET */
        .weather-section { padding: 30px; background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%); margin: 20px; border-radius: 15px; color: white; }
        .weather-title { text-align: center; font-size: 1.8em; margin-bottom: 20px; }
        .weather-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .weather-card { background: rgba(255, 255, 255, 0.1); padding: 20px; border-radius: 12px; text-align: center; }
        .weather-card h3 { margin-bottom: 10px; }
        .weather-temp { font-size: 2em; font-weight: bold; }
        .weather-desc { margin-top: 5px; font-size: 0.9em; opacity: 0.9; }
        
        /* NAVIGATION */
        .islands-nav { background: rgba(255, 255, 255, 0.9); padding: 20px; display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; }
        .island-btn { background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); color: #333; padding: 12px 24px; border: none; border-radius: 20px; cursor: pointer; font-weight: bold; }
        .island-btn.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        
        /* ITINERARY */
        .itinerary-section { padding: 30px; }
        .itinerary-title { text-align: center; font-size: 1.8em; color: #333; margin-bottom: 30px; }
        .day-card { background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); margin-bottom: 20px; overflow: hidden; }
        .day-card.hidden { display: none; }
        .day-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center; }
        .day-date { font-size: 1.3em; font-weight: bold; }
        .day-location { background: rgba(255, 255, 255, 0.2); padding: 8px 16px; border-radius: 20px; }
        .day-content { padding: 25px; }
        .activity-input { width: 100%; padding: 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1em; margin-bottom: 15px; resize: vertical; min-height: 80px; }
        .bnb-section { background: #f8f9fa; padding: 20px; border-radius: 10px; margin-top: 15px; }
        .bnb-title { font-size: 1.1em; color: #333; margin-bottom: 10px; }
        .bnb-input, .bnb-name-input { width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; margin-bottom: 10px; }
        .bnb-link-container { margin-top: 10px; }
        .bnb-link { display: inline-block; background: #4facfe; color: white; padding: 8px 16px; border-radius: 20px; text-decoration: none; font-weight: bold; transition: background 0.3s ease; }
        .bnb-link:hover { background: #369bff; }
        
        /* SHARING */
        .share-section { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); padding: 30px; text-align: center; }
        .share-title { font-size: 1.5em; color: #333; margin-bottom: 20px; }
        .share-buttons { display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; }
        .share-btn { background: #4facfe; color: white; padding: 12px 24px; border: none; border-radius: 25px; cursor: pointer; }
        .last-updated { text-align: center; color: #666; font-size: 0.9em; padding: 10px; }
        
        @media (max-width: 768px) {
            .budget-grid { grid-template-columns: 1fr; }
            .weather-grid { grid-template-columns: 1fr; }
            .status-bar { position: relative; top: 0; right: 0; margin-bottom: 20px; }
        }
    </style>
</head>
<body>
    <div class="status-bar">
        <div class="connection-status" id="connectionStatus">ğŸŒ Online</div>
        <div class="online-users">
            <h4 id="onlineCount">ğŸ‘¥ Online (1)</h4>
            <div class="user-list" id="userList">
                <span class="user-badge">Tu</span>
            </div>
        </div>
    </div>
    
    <div class="container">
        <div class="header">
            <h1>ğŸ‡¬ğŸ‡· Viaggio Isole Greche 2024</h1>
            <p>Mykonos â€¢ Paros â€¢ Naxos</p>
        </div>

        <div class="islands-nav">
            <button class="island-btn active" onclick="showIsland('all', this)">Tutti i Giorni</button>
            <button class="island-btn" onclick="showIsland('mykonos', this)">ğŸï¸ Mykonos</button>
            <button class="island-btn" onclick="showIsland('paros', this)">ğŸŒŠ Paros</button>
            <button class="island-btn" onclick="showIsland('naxos', this)">ğŸ–ï¸ Naxos</button>
        </div>

        <!-- BUDGET SECTION -->
        <div class="budget-section">
            <h2 class="budget-title">ğŸ’° Budget Collaborativo</h2>
            <div class="budget-grid">
                <div class="budget-item">
                    <h3>âœˆï¸ Volo Andata/Ritorno</h3>
                    <input type="number" class="budget-input" value="400" min="0" step="0.01">
                </div>
                <div class="budget-item">
                    <h3>ğŸ¨ Hotel Mykonos (3 notti)</h3>
                    <input type="number" class="budget-input" value="269" min="0" step="0.01">
                </div>
                <div class="budget-item">
                    <h3>ğŸš¢ Traghetto Mykonos â†’ Paros</h3>
                    <input type="number" class="budget-input" value="52" min="0" step="0.01">
                </div>
                <div class="budget-item">
                    <h3>ğŸ¨ Hotel Paros (2 notti)</h3>
                    <input type="number" class="budget-input" value="140" min="0" step="0.01">
                </div>
                <div class="budget-item">
                    <h3>ğŸš¢ Traghetto Paros â†’ Naxos</h3>
                    <input type="number" class="budget-input" value="21" min="0" step="0.01">
                </div>
                <div class="budget-item">
                    <h3>ğŸ¨ Hotel Naxos (2 notti)</h3>
                    <input type="number" class="budget-input" value="145.33" min="0" step="0.01">
                </div>
                <div class="budget-item">
                    <h3>ğŸš¢ Traghetto Naxos â†’ Mykonos</h3>
                    <input type="number" class="budget-input" value="36" min="0" step="0.01">
                </div>
                <div class="budget-item">
                    <h3>ğŸš• Taxi & Trasporti Extra</h3>
                    <input type="number" class="budget-input" value="100" min="0" step="0.01">
                </div>
                <div class="budget-item">
                    <h3>ğŸ½ï¸ Cibo & Ristoranti</h3>
                    <input type="number" class="budget-input" value="300" min="0" step="0.01">
                </div>
            </div>
            <div class="total-cost">ğŸ’³ Totale Budget: â‚¬<span id="totalBudget">1563.33</span></div>
        </div>

        <!-- METEO -->
        <div class="weather-section">
            <h2 class="weather-title">ğŸŒ¤ï¸ Meteo in Tempo Reale</h2>
            <div class="weather-grid">
                <div class="weather-card">
                    <h3>ğŸï¸ Mykonos</h3>
                    <div class="weather-temp" id="weather-mykonos">26Â°C</div>
                    <div class="weather-desc" id="desc-mykonos">â˜€ï¸ Sereno</div>
                </div>
                <div class="weather-card">
                    <h3>ğŸŒŠ Paros</h3>
                    <div class="weather-temp" id="weather-paros">24Â°C</div>
                    <div class="weather-desc" id="desc-paros">ğŸŒ¤ï¸ Parzialmente nuvoloso</div>
                </div>
                <div class="weather-card">
                    <h3>ğŸ–ï¸ Naxos</h3>
                    <div class="weather-temp" id="weather-naxos">25Â°C</div>
                    <div class="weather-desc" id="desc-naxos">â˜€ï¸ Sereno</div>
                </div>
            </div>
        </div>

        <!-- ITINERARIO -->
        <div class="itinerary-section">
            <h2 class="itinerary-title">ğŸ“… Itinerario Collaborativo</h2>
            
            <div class="day-card" data-island="mykonos" data-day="2024-08-02">
                <div class="day-header">
                    <div class="day-date">ğŸ—“ï¸ 2 Agosto</div>
                    <div class="day-location">Mykonos</div>
                </div>
                <div class="day-content">
                    <textarea class="activity-input" placeholder="Descrivi le attivitÃ  del giorno...">Arrivo a Mykonos, check-in hotel, esplorazione Little Venice al tramonto</textarea>
                    <div class="bnb-section">
                        <div class="bnb-title">ğŸ  Alloggio Mykonos</div>
                        <input type="text" class="bnb-name-input" placeholder="Nome alloggio..." value="Hotel Belvedere">
                        <input type="url" class="bnb-input" placeholder="Link BnB o hotel..." value="https://www.belvederehotel.com">
                        <div class="bnb-link-container">
                            <a href="https://www.belvederehotel.com" target="_blank" class="bnb-link">ğŸ  Vedi Hotel Belvedere</a>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="day-card" data-island="mykonos" data-day="2024-08-03">
                <div class="day-header">
                    <div class="day-date">ğŸ—“ï¸ 3 Agosto</div>
                    <div class="day-location">Mykonos</div>
                </div>
                <div class="day-content">
                    <textarea class="activity-input" placeholder="Descrivi le attivitÃ  del giorno...">Giornata alle spiagge di Paradise e Super Paradise, aperitivo a Mykonos Town</textarea>
                </div>
            </div>
            
            <div class="day-card" data-island="mykonos" data-day="2024-08-04">
                <div class="day-header">
                    <div class="day-date">ğŸ—“ï¸ 4 Agosto</div>
                    <div class="day-location">Mykonos</div>
                </div>
                <div class="day-content">
                    <textarea class="activity-input" placeholder="Descrivi le attivitÃ  del giorno...">Escursione a Delos, shopping nel centro, cena tipica greca</textarea>
                </div>
            </div>

            <div class="day-card" data-island="paros" data-day="2024-08-05">
                <div class="day-header">
                    <div class="day-date">ğŸ—“ï¸ 5 Agosto</div>
                    <div class="day-location">Paros</div>
                </div>
                <div class="day-content">
                    <textarea class="activity-input" placeholder="Descrivi le attivitÃ  del giorno...">Traghetto per Paros, check-in, esplorazione di Naoussa</textarea>
                    <div class="bnb-section">
                        <div class="bnb-title">ğŸ  Alloggio Paros</div>
                        <input type="text" class="bnb-name-input" placeholder="Nome alloggio..." value="Paros Bay Hotel">
                        <input type="url" class="bnb-input" placeholder="Link BnB o hotel..." value="https://www.parosbay.gr">
                        <div class="bnb-link-container">
                            <a href="https://www.parosbay.gr" target="_blank" class="bnb-link">ğŸ  Vedi Paros Bay Hotel</a>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="day-card" data-island="paros" data-day="2024-08-06">
                <div class="day-header">
                    <div class="day-date">ğŸ—“ï¸ 6 Agosto</div>
                    <div class="day-location">Paros</div>
                </div>
                <div class="day-content">
                    <textarea class="activity-input" placeholder="Descrivi le attivitÃ  del giorno...">Spiaggia di Golden Beach, visita al villaggio di Lefkes</textarea>
                </div>
            </div>

            <div class="day-card" data-island="naxos" data-day="2024-08-07">
                <div class="day-header">
                    <div class="day-date">ğŸ—“ï¸ 7 Agosto</div>
                    <div class="day-location">Naxos</div>
                </div>
                <div class="day-content">
                    <textarea class="activity-input" placeholder="Descrivi le attivitÃ  del giorno...">Traghetto per Naxos, check-in, visita alla Portara al tramonto</textarea>
                    <div class="bnb-section">
                        <div class="bnb-title">ğŸ  Alloggio Naxos</div>
                        <input type="text" class="bnb-name-input" placeholder="Nome alloggio..." value="Hotel Grotta">
                        <input type="url" class="bnb-input" placeholder="Link BnB o hotel..." value="https://www.hotelgrotta.gr">
                        <div class="bnb-link-container">
                            <a href="https://www.hotelgrotta.gr" target="_blank" class="bnb-link">ğŸ  Vedi Hotel Grotta</a>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="day-card" data-island="naxos" data-day="2024-08-08">
                <div class="day-header">
                    <div class="day-date">ğŸ—“ï¸ 8 Agosto</div>
                    <div class="day-location">Naxos</div>
                </div>
                <div class="day-content">
                    <textarea class="activity-input" placeholder="Descrivi le attivitÃ  del giorno...">Spiaggia di Plaka, escursione nell'entroterra, cena tradizionale</textarea>
                </div>
            </div>

            <div class="day-card" data-island="mykonos" data-day="2024-08-09">
                <div class="day-header">
                    <div class="day-date">ğŸ—“ï¸ 9 Agosto</div>
                    <div class="day-location">Rientro a Mykonos</div>
                </div>
                <div class="day-content">
                    <textarea class="activity-input" placeholder="Descrivi le attivitÃ  del giorno...">Traghetto di ritorno, ultimo shopping, volo di rientro</textarea>
                </div>
            </div>
        </div>

        <div class="last-updated">
            Ultimo aggiornamento: <span id="lastUpdate">Ora</span>
        </div>

        <div class="share-section">
            <h2 class="share-title">ğŸ“± Condividi il Viaggio</h2>
            <div class="share-buttons">
                <button class="share-btn" onclick="shareWhatsApp()">ğŸ“± WhatsApp</button>
                <button class="share-btn" onclick="shareEmail()">ğŸ“§ Email</button>
                <button class="share-btn" onclick="copyLink()">ğŸ”— Copia Link</button>
            </div>
        </div>
    </div>

    <script>
        // VARIABILI GLOBALI PER TRACKING UTENTI REALI
        let saveTimeout = null;
        let userName = localStorage.getItem('userName') || generateRandomName();
        let userIP = localStorage.getItem('userIP') || null;
        let lastUserCount = 1;
        let onlineUsers = new Map(); // Mappa IP -> {name, lastSeen, location}
        let heartbeatInterval = null;

        // OTTIENI IP PUBBLICO REALE
        async function getUserPublicIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch (error) {
                console.log('Fallback IP detection...');
                try {
                    const response = await fetch('https://httpbin.org/ip');
                    const data = await response.json();
                    return data.origin.split(',')[0]; // Prende il primo IP se ce ne sono piÃ¹
                } catch (error2) {
                    console.error('Impossibile ottenere IP pubblico:', error2);
                    return 'IP_' + Math.random().toString(36).substr(2, 8); // Fallback con ID casuale
                }
            }
        }

        // OTTIENI INFORMAZIONI GEOGRAFICHE APPROSSIMATIVE
        async function getUserLocation(ip) {
            try {
                const response = await fetch(`https://ipapi.co/${ip}/json/`);
                const data = await response.json();
                return {
                    city: data.city || 'Sconosciuta',
                    country: data.country_name || 'Sconosciuto',
                    countryCode: data.country_code || 'XX'
                };
            } catch (error) {
                return {
                    city: 'Sconosciuta',
                    country: 'Sconosciuto', 
                    countryCode: 'XX'
                };
            }
        }

        // GENERA IDENTIFICATORE UTENTE UNICO BASATO SU IP
        function generateUserIdentifier(ip) {
            // Crea un hash semplice dell'IP per privacy (mostra solo ultime 3 cifre)
            const ipParts = ip.split('.');
            if (ipParts.length === 4) {
                return `${ipParts[0]}.xxx.xxx.${ipParts[3]}`;
            }
            return ip.substring(0, 8) + '...'; // Per IPv6 o altri formati
        }

        // SISTEMA DI HEARTBEAT PER RILEVARE UTENTI ATTIVI
        function startHeartbeat() {
            heartbeatInterval = setInterval(async () => {
                if (userIP) {
                    const currentTime = Date.now();
                    
                    // Aggiorna il nostro timestamp
                    const userData = {
                        name: userName,
                        lastSeen: currentTime,
                        location: onlineUsers.get(userIP)?.location || { city: 'Caricamento...', countryCode: 'XX' }
                    };
                    
                    onlineUsers.set(userIP, userData);
                    
                    // Rimuovi utenti non visti da piÃ¹ di 30 secondi
                    const cutoffTime = currentTime - 30000;
                    for (const [ip, user] of onlineUsers.entries()) {
                        if (user.lastSeen < cutoffTime && ip !== userIP) {
                            onlineUsers.delete(ip);
                        }
                    }
                    
                    // Salva nel localStorage condiviso
                    const onlineData = {
                        users: Object.fromEntries(onlineUsers),
                        lastUpdate: currentTime
                    };
                    
                    try {
                        localStorage.setItem('onlineUsers', JSON.stringify(onlineData));
                        // Simula sincronizzazione cross-tab
                        window.dispatchEvent(new StorageEvent('storage', {
                            key: 'onlineUsers',
                            newValue: JSON.stringify(onlineData)
                        }));
                    } catch (error) {
                        console.error('Errore salvataggio utenti online:', error);
                    }
                    
                    updateOnlineUsersDisplay();
                }
            }, 5000); // Heartbeat ogni 5 secondi
        }

        // CARICA UTENTI ONLINE DA STORAGE CONDIVISO
        function loadOnlineUsers() {
            try {
                const stored = localStorage.getItem('onlineUsers');
                if (stored) {
                    const data = JSON.parse(stored);
                    const currentTime = Date.now();
                    
                    // Carica solo utenti visti negli ultimi 30 secondi
                    const cutoffTime = currentTime - 30000;
                    for (const [ip, user] of Object.entries(data.users)) {
                        if (user.lastSeen > cutoffTime) {
                            onlineUsers.set(ip, user);
                        }
                    }
                }
            } catch (error) {
                console.error('Errore caricamento utenti online:', error);
            }
        }

        // AGGIORNA DISPLAY UTENTI ONLINE (VERSIONE REALE)
        function updateOnlineUsersDisplay() {
            const userCount = onlineUsers.size;
            document.getElementById('onlineCount').textContent = `ğŸ‘¥ Online (${userCount})`;
            
            const userList = document.getElementById('userList');
            userList.innerHTML = '';
            
            // Mostra l'utente corrente per primo
            if (userIP) {
                const currentUser = onlineUsers.get(userIP);
                if (currentUser) {
                    const flag = getCountryFlag(currentUser.location?.countryCode || 'XX');
                    userList.innerHTML += `<span class="user-badge" style="background: rgba(76, 175, 80, 0.3);" title="Tu - ${currentUser.location?.city || 'Posizione sconosciuta'}">${flag} Tu (${userName})</span>`;
                }
            }
            
            // Mostra altri utenti online
            for (const [ip, user] of onlineUsers.entries()) {
                if (ip !== userIP) {
                    const ipDisplay = generateUserIdentifier(ip);
                    const flag = getCountryFlag(user.location?.countryCode || 'XX');
                    const timeSinceLastSeen = Math.floor((Date.now() - user.lastSeen) / 1000);
                    const statusIndicator = timeSinceLastSeen < 10 ? 'ğŸŸ¢' : timeSinceLastSeen < 20 ? 'ğŸŸ¡' : 'ğŸ”´';
                    
                    userList.innerHTML += `<span class="user-badge" title="${user.name} da ${user.location?.city || 'Posizione sconosciuta'} (${ipDisplay}) - ${timeSinceLastSeen}s fa">${flag} ${statusIndicator} ${user.name}</span>`;
                }
            }
        }

        // OTTIENI FLAG EMOJI PER PAESE
        function getCountryFlag(countryCode) {
            const flags = {
                'IT': 'ğŸ‡®ğŸ‡¹', 'US': 'ğŸ‡ºğŸ‡¸', 'GB': 'ğŸ‡¬ğŸ‡§', 'FR': 'ğŸ‡«ğŸ‡·', 'DE': 'ğŸ‡©ğŸ‡ª', 'ES': 'ğŸ‡ªğŸ‡¸',
                'NL': 'ğŸ‡³ğŸ‡±', 'BE': 'ğŸ‡§ğŸ‡ª', 'CH': 'ğŸ‡¨ğŸ‡­', 'AT': 'ğŸ‡¦ğŸ‡¹', 'PT': 'ğŸ‡µğŸ‡¹', 'GR': 'ğŸ‡¬ğŸ‡·',
                'XX': 'ğŸŒ' // Default per sconosciuto
            };
            return flags[countryCode] || 'ğŸŒ';
        }

        // INIZIALIZZA TRACKING UTENTI REALI
        async function initializeUserTracking() {
            console.log('ğŸ” Inizializzazione tracking utenti reali...');
            
            try {
                // Ottieni IP pubblico
                userIP = await getUserPublicIP();
                localStorage.setItem('userIP', userIP);
                console.log(`ğŸ“ IP rilevato: ${generateUserIdentifier(userIP)}`);
                
                // Ottieni informazioni geografiche
                const location = await getUserLocation(userIP);
                console.log(`ğŸŒ Posizione: ${location.city}, ${location.country}`);
                
                // Aggiungi questo utente alla lista
                onlineUsers.set(userIP, {
                    name: userName,
                    lastSeen: Date.now(),
                    location: location
                });
                
                // Carica altri utenti online
                loadOnlineUsers();
                
                // Avvia heartbeat
                startHeartbeat();
                
                // Listener per cambiamenti storage (altri tab)
                window.addEventListener('storage', (e) => {
                    if (e.key === 'onlineUsers') {
                        loadOnlineUsers();
                        updateOnlineUsersDisplay();
                    }
                });
                
                // Cleanup quando l'utente chiude la pagina
                window.addEventListener('beforeunload', () => {
                    if (heartbeatInterval) {
                        clearInterval(heartbeatInterval);
                    }
                    // Rimuovi questo utente (verrÃ  rimosso automaticamente dal timeout)
                });
                
                // Update display iniziale
                updateOnlineUsersDisplay();
                
            } catch (error) {
                console.error('âŒ Errore inizializzazione tracking:', error);
                // Fallback alla versione simulata
                updateOnlineUsersFallback();
            }
        }

        // FALLBACK ALLA VERSIONE SIMULATA
        function updateOnlineUsersFallback() {
            const userCount = Math.floor(Math.random() * 4) + 1;
            const names = ['Marco', 'Giulia', 'Luca', 'Sofia', 'Alessandro'];
            
            document.getElementById('onlineCount').textContent = `ğŸ‘¥ Online (${userCount}) - Simulato`;
            
            const userList = document.getElementById('userList');
            userList.innerHTML = `<span class="user-badge" style="background: rgba(76, 175, 80, 0.3);">ğŸ‡®ğŸ‡¹ Tu (${userName})</span>`;
            
            for (let i = 1; i < userCount; i++) {
                const randomName = names[Math.floor(Math.random() * names.length)];
                const randomFlag = ['ğŸ‡®ğŸ‡¹', 'ğŸ‡ºğŸ‡¸', 'ğŸ‡¬ğŸ‡§', 'ğŸ‡«ğŸ‡·', 'ğŸ‡©ğŸ‡ª'][Math.floor(Math.random() * 5)];
                if (randomName !== userName) {
                    userList.innerHTML += `<span class="user-badge">${randomFlag} ${randomName}</span>`;
                }
            }
        }

        // CALCOLO BUDGET
        function calculateTotal() {
            let total = 0;
            document.querySelectorAll('.budget-input').forEach(input => {
                total += parseFloat(input.value) || 0;
            });
            document.getElementById('totalBudget').textContent = total.toFixed(2);
        }

        // AGGIORNA LINK ALLOGGI
        function updateAccommodationLinks() {
            document.querySelectorAll('.bnb-section').forEach(section => {
                const nameInput = section.querySelector('.bnb-name-input');
                const urlInput = section.querySelector('.bnb-input');
                const linkContainer = section.querySelector('.bnb-link-container');
                
                if (!nameInput || !urlInput || !linkContainer) return;
                
                const name = nameInput.value.trim();
                const url = urlInput.value.trim();
                
                if (name && url) {
                    const fullUrl = url.startsWith('http') ? url : `https://${url}`;
                    linkContainer.innerHTML = `<a href="${fullUrl}" target="_blank" class="bnb-link">ğŸ  Vedi ${name}</a>`;
                } else if (name) {
                    linkContainer.innerHTML = `<span class="bnb-link" style="background: #ccc; cursor: default;">ğŸ  ${name} (aggiungi link)</span>`;
                } else {
                    linkContainer.innerHTML = '';
                }
            });
        }

        // SALVATAGGIO DATI
        function saveData() {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                updateStatus('ğŸ’¾ Salvando...', 'saving');
                
                const data = {
                    budget: {},
                    activities: {},
                    accommodations: {},
                    lastUpdated: new Date().toISOString(),
                    lastUpdatedBy: userName
                };
                
                // Salva budget
                document.querySelectorAll('.budget-input').forEach((input, index) => {
                    data.budget[`item_${index}`] = parseFloat(input.value) || 0;
                });
                
                // Salva attivitÃ 
                document.querySelectorAll('.activity-input').forEach((input, index) => {
                    if (input.value.trim()) {
                        data.activities[`activity_${index}`] = input.value;
                    }
                });
                
                // Salva alloggi
                document.querySelectorAll('.bnb-section').forEach((section, index) => {
                    const nameInput = section.querySelector('.bnb-name-input');
                    const urlInput = section.querySelector('.bnb-input');
                    
                    if (nameInput && urlInput) {
                        data.accommodations[`acc_${index}`] = {
                            name: nameInput.value || '',
                            url: urlInput.value || ''
                        };
                    }
                });
                
                try {
                    localStorage.setItem('tripData', JSON.stringify(data));
                    setTimeout(() => {
                        updateStatus('ğŸŒ Salvato');
                        document.getElementById('lastUpdate').textContent = `${new Date().toLocaleString('it-IT')} da ${userName}`;
                    }, 500);
                } catch (error) {
                    updateStatus('âŒ Errore salvataggio', 'offline');
                }
            }, 1000);
        }

        // CARICAMENTO DATI
        function loadData() {
            try {
                const savedData = localStorage.getItem('tripData');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    
                    // Carica budget
                    if (data.budget) {
                        Object.entries(data.budget).forEach(([key, value]) => {
                            const index = parseInt(key.replace('item_', ''));
                            const input = document.querySelectorAll('.budget-input')[index];
                            if (input) input.value = value;
                        });
                        calculateTotal();
                    }
                    
                    // Carica attivitÃ 
                    if (data.activities) {
                        Object.entries(data.activities).forEach(([key, value]) => {
                            const index = parseInt(key.replace('activity_', ''));
                            const input = document.querySelectorAll('.activity-input')[index];
                            if (input) input.value = value;
                        });
                    }
                    
                    // Carica alloggi
                    if (data.accommodations) {
                        Object.entries(data.accommodations).forEach(([key, acc]) => {
                            const index = parseInt(key.replace('acc_', ''));
                            const section = document.querySelectorAll('.bnb-section')[index];
                            if (section) {
                                const nameInput = section.querySelector('.bnb-name-input');
                                const urlInput = section.querySelector('.bnb-input');
                                
                                if (nameInput) nameInput.value = acc.name || '';
                                if (urlInput) urlInput.value = acc.url || '';
                            }
                        });
                        updateAccommodationLinks();
                    }
                    
                    if (data.lastUpdatedBy) {
                        const date = new Date(data.lastUpdated).toLocaleString('it-IT');
                        document.getElementById('lastUpdate').textContent = `${date} da ${data.lastUpdatedBy}`;
                    }
                }
            } catch (error) {
                console.error('Errore caricamento dati:', error);
            }
        }

        // FILTRI ISOLE
        function showIsland(island, btn) {
            document.querySelectorAll('.day-card').forEach(card => {
                card.classList.toggle('hidden', island !== 'all' && card.dataset.island !== island);
            });
            document.querySelectorAll('.island-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        // CONDIVISIONE
        function shareWhatsApp() {
            const message = `ğŸ‡¬ğŸ‡· Itinerario Isole Greche 2024!\nMykonos â€¢ Paros â€¢ Naxos\nCollabora qui: ${window.location.href}`;
            window.open(`https://wa.me/?text=${encodeURIComponent(message)}`, '_blank');
        }

        function shareEmail() {
            const subject = "Viaggio Isole Greche 2024";
            const body = `Ciao! Ecco il nostro itinerario per le isole greche. Puoi modificarlo qui: ${window.location.href}`;
            window.open(`mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`);
        }

        function copyLink() {
            navigator.clipboard.writeText(window.location.href)
                .then(() => alert('Link copiato negli appunti!'))
                .catch(() => alert('Errore nella copia del link.'));
        }

        // METEO REALE
        async function loadWeather() {
            const locations = [
                { name: 'mykonos', lat: 37.4467, lon: 25.3289 },
                { name: 'paros', lat: 37.0854, lon: 25.1389 },
                { name: 'naxos', lat: 37.1035, lon: 25.3769 }
            ];

            for (const location of locations) {
                try {
                    const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${location.lat}&longitude=${location.lon}&current_weather=true&timezone=Europe%2FAthens`);
                    const data = await response.json();
                    
                    if (data.current_weather) {
                        const temp = Math.round(data.current_weather.temperature);
                        const weatherCode = data.current_weather.weathercode;
                        const description = getWeatherDescription(weatherCode);
                        
                        document.getElementById(`weather-${location.name}`).textContent = `${temp}Â°C`;
                        document.getElementById(`desc-${location.name}`).textContent = description;
                    }
                } catch (error) {
                    console.error(`Errore meteo per ${location.name}:`, error);
                }
            }
        }

        function getWeatherDescription(code) {
            const descriptions = {
                0: 'â˜€ï¸ Sereno', 1: 'ğŸŒ¤ï¸ Prevalentemente sereno', 2: 'â›… Parzialmente nuvoloso',
                3: 'â˜ï¸ Nuvoloso', 45: 'ğŸŒ«ï¸ Nebbia', 48: 'ğŸŒ«ï¸ Nebbia con brina',
                51: 'ğŸŒ¦ï¸ Pioggerella leggera', 53: 'ğŸŒ¦ï¸ Pioggerella moderata', 55: 'ğŸŒ¦ï¸ Pioggerella intensa',
                61: 'ğŸŒ§ï¸ Pioggia leggera', 63: 'ğŸŒ§ï¸ Pioggia moderata', 65: 'ğŸŒ§ï¸ Pioggia intensa',
                80: 'ğŸŒ¦ï¸ Rovesci leggeri', 81: 'ğŸŒ¦ï¸ Rovesci moderati', 82: 'â›ˆï¸ Rovesci intensi',
                95: 'â›ˆï¸ Temporale', 96: 'â›ˆï¸ Temporale con grandine'
            };
            return descriptions[code] || 'ğŸŒ¤ï¸ Variabile';
        }

        // INIZIALIZZAZIONE
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ App inizializzata!');
            
            // Carica dati salvati
            loadData();
            
            // Calcola totale iniziale
            calculateTotal();
            
            // Aggiorna link alloggi
            updateAccommodationLinks();
            
            // INIZIALIZZA TRACKING UTENTI REALI
            initializeUserTracking();
            
            // Carica meteo
            loadWeather();
            setInterval(loadWeather, 300000); // Aggiorna ogni 5 minuti
            
            // Event listeners
            document.querySelectorAll('.budget-input').forEach(input => {
                input.addEventListener('input', () => {
                    calculateTotal();
                    saveData();
                });
            });
            
            document.querySelectorAll('.activity-input').forEach(input => {
                input.addEventListener('input', saveData);
            });
            
            document.querySelectorAll('.bnb-name-input, .bnb-input').forEach(input => {
                input.addEventListener('input', () => {
                    updateAccommodationLinks();
                    saveData();
                });
            });
            
            // Status iniziale
            updateStatus('ğŸŒ Online e Funzionante!');
            document.getElementById('lastUpdate').textContent = new Date().toLocaleString('it-IT');
        });
    </script>
</body>
</html>
