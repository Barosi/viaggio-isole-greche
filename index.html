
<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Viaggio Isole Greche 2024 - Mykonos, Paros, Naxos</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Arial', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: rgba(255, 255, 255, 0.95); border-radius: 20px; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1); overflow: hidden; }
        .header { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .header p { font-size: 1.2em; }
        .connection-status { position: fixed; top: 20px; right: 20px; background: rgba(40, 167, 69, 0.9); color: white; padding: 10px 15px; border-radius: 20px; font-size: 0.9em; z-index: 1000; transition: all 0.3s ease; }
        .connection-status.saving { background: rgba(255, 193, 7, 0.9); }
        .connection-status.offline { background: rgba(220, 53, 69, 0.9); }
        .budget-section { padding: 30px; background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); margin: 20px; border-radius: 15px; }
        .budget-title { text-align: center; font-size: 1.5em; color: #8b4513; margin-bottom: 20px; }
        .budget-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; }
        .budget-item { background: white; padding: 15px; border-radius: 10px; border-left: 4px solid #ff6b6b; }
        .budget-item h3 { color: #333; }
        .budget-item .cost { color: #ff6b6b; font-weight: bold; font-size: 1.2em; }
        .total-cost { background: #333; color: white; padding: 15px; border-radius: 10px; text-align: center; margin-top: 20px; font-size: 1.3em; }
        .itinerary-section { padding: 30px; }
        .itinerary-title { text-align: center; font-size: 1.8em; color: #333; margin-bottom: 30px; }
        .day-card { background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); margin-bottom: 20px; overflow: hidden; }
        .day-card.hidden { display: none; }
        .day-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center; }
        .day-date { font-size: 1.3em; font-weight: bold; }
        .day-location { background: rgba(255, 255, 255, 0.2); padding: 8px 16px; border-radius: 20px; }
        .day-content { padding: 25px; }
        .activity-input { width: 100%; padding: 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1em; margin-bottom: 15px; resize: vertical; min-height: 80px; }
        .bnb-section { background: #f8f9fa; padding: 20px; border-radius: 10px; margin-top: 15px; }
        .bnb-title { font-size: 1.1em; color: #333; margin-bottom: 10px; }
        .bnb-input, .bnb-name-input { width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; margin-bottom: 10px; }
        .bnb-link-container { margin-top: 10px; }
        .bnb-link { display: inline-block; background: #4facfe; color: white; padding: 8px 16px; border-radius: 20px; text-decoration: none; font-weight: bold; transition: background 0.3s ease; }
        .bnb-link:hover { background: #369bff; }
        .islands-nav { background: rgba(255, 255, 255, 0.9); padding: 20px; display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; }
        .island-btn { background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); color: #333; padding: 12px 24px; border: none; border-radius: 20px; cursor: pointer; font-weight: bold; }
        .island-btn.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .share-section { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); padding: 30px; text-align: center; }
        .share-title { font-size: 1.5em; color: #333; margin-bottom: 20px; }
        .share-buttons { display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; }
        .share-btn { background: #4facfe; color: white; padding: 12px 24px; border: none; border-radius: 25px; cursor: pointer; }
        .last-updated { text-align: center; color: #666; font-size: 0.9em; padding: 10px; }
    </style>
</head>
<body>
    <div class="connection-status" id="connectionStatus">🔄 Connessione...</div>
    
    <div class="container">
        <div class="header">
            <h1>🇬🇷 Viaggio Isole Greche 2024</h1>
            <p>Mykonos • Paros • Naxos</p>
        </div>

        <div class="islands-nav">
            <button class="island-btn active" onclick="showIsland('all', this)">Tutti i Giorni</button>
            <button class="island-btn" onclick="showIsland('mykonos', this)">🏝️ Mykonos</button>
            <button class="island-btn" onclick="showIsland('paros', this)">🌊 Paros</button>
            <button class="island-btn" onclick="showIsland('naxos', this)">🏖️ Naxos</button>
        </div>

        <div class="budget-section">
            <h2 class="budget-title">💰 Budget Stimato</h2>
            <div class="budget-grid">
                <div class="budget-item"><h3>✈️ Volo A/R</h3><div class="cost">€400,00</div></div>
                <div class="budget-item"><h3>🏨 Hotel Mykonos</h3><div class="cost">€269,00</div></div>
                <div class="budget-item"><h3>🚢 Traghetto My-Pa</h3><div class="cost">€52,00</div></div>
                <div class="budget-item"><h3>🏨 Hotel Paros</h3><div class="cost">€140,00</div></div>
                <div class="budget-item"><h3>🚢 Traghetto Pa-Na</h3><div class="cost">€21,00</div></div>
                <div class="budget-item"><h3>🏨 Hotel Naxos</h3><div class="cost">€145,33</div></div>
                <div class="budget-item"><h3>🚢 Traghetto Na-My</h3><div class="cost">€36,00</div></div>
                <div class="budget-item"><h3>🚕 Taxi & Extra</h3><div class="cost">€100,00</div></div>
            </div>
            <div class="total-cost">💳 Totale Stimato: €1.163,33</div>
        </div>

        <div class="itinerary-section">
            <h2 class="itinerary-title">📅 Itinerario Collaborativo</h2>
            
            <div class="day-card" data-island="mykonos" data-day="2024-08-02">
                <div class="day-header"><div class="day-date">🗓️ 2 Agosto</div><div class="day-location">Mykonos</div></div>
                <div class="day-content">
                    <textarea class="activity-input" placeholder="Descrivi le attività..."></textarea>
                    <div class="bnb-section">
                        <div class="bnb-title">🏠 Alloggio Mykonos</div>
                        <input type="text" class="bnb-name-input" placeholder="Nome alloggio...">
                        <input type="url" class="bnb-input" placeholder="Link BnB o hotel...">
                        <div class="bnb-link-container"></div>
                    </div>
                </div>
            </div>
            <div class="day-card" data-island="mykonos" data-day="2024-08-03">
                <div class="day-header"><div class="day-date">🗓️ 3 Agosto</div><div class="day-location">Mykonos</div></div>
                <div class="day-content"><textarea class="activity-input" placeholder="Descrivi le attività..."></textarea></div>
            </div>
            <div class="day-card" data-island="mykonos" data-day="2024-08-04">
                <div class="day-header"><div class="day-date">🗓️ 4 Agosto</div><div class="day-location">Mykonos</div></div>
                <div class="day-content"><textarea class="activity-input" placeholder="Descrivi le attività..."></textarea></div>
            </div>

            <div class="day-card" data-island="paros" data-day="2024-08-05">
                <div class="day-header"><div class="day-date">🗓️ 5 Agosto</div><div class="day-location">Paros</div></div>
                <div class="day-content">
                    <textarea class="activity-input" placeholder="Descrivi le attività..."></textarea>
                    <div class="bnb-section">
                        <div class="bnb-title">🏠 Alloggio Paros</div>
                        <input type="text" class="bnb-name-input" placeholder="Nome alloggio...">
                        <input type="url" class="bnb-input" placeholder="Link BnB o hotel...">
                        <div class="bnb-link-container"></div>
                    </div>
                </div>
            </div>
            <div class="day-card" data-island="paros" data-day="2024-08-06">
                <div class="day-header"><div class="day-date">🗓️ 6 Agosto</div><div class="day-location">Paros</div></div>
                <div class="day-content"><textarea class="activity-input" placeholder="Descrivi le attività..."></textarea></div>
            </div>

            <div class="day-card" data-island="naxos" data-day="2024-08-07">
                <div class="day-header"><div class="day-date">🗓️ 7 Agosto</div><div class="day-location">Naxos</div></div>
                <div class="day-content">
                    <textarea class="activity-input" placeholder="Descrivi le attività..."></textarea>
                    <div class="bnb-section">
                        <div class="bnb-title">🏠 Alloggio Naxos</div>
                        <input type="text" class="bnb-name-input" placeholder="Nome alloggio...">
                        <input type="url" class="bnb-input" placeholder="Link BnB o hotel...">
                        <div class="bnb-link-container"></div>
                    </div>
                </div>
            </div>
            <div class="day-card" data-island="naxos" data-day="2024-08-08">
                <div class="day-header"><div class="day-date">🗓️ 8 Agosto</div><div class="day-location">Naxos</div></div>
                <div class="day-content"><textarea class="activity-input" placeholder="Descrivi le attività..."></textarea></div>
            </div>

            <div class="day-card" data-island="mykonos" data-day="2024-08-09">
                <div class="day-header"><div class="day-date">🗓️ 9 Agosto</div><div class="day-location">Rientro a Mykonos</div></div>
                <div class="day-content"><textarea class="activity-input" placeholder="Descrivi le attività..."></textarea></div>
            </div>
        </div>

        <div class="last-updated">Ultimo aggiornamento: <span id="lastUpdate">...</span></div>

        <div class="share-section">
            <h2 class="share-title">📱 Condividi il Viaggio</h2>
            <div class="share-buttons">
                <button class="share-btn" onclick="shareWhatsApp()">📱 WhatsApp</button>
                <button class="share-btn" onclick="shareEmail()">📧 Email</button>
                <button class="share-btn" onclick="copyLink()">🔗 Copia Link</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        // --- CONFIGURAZIONE FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyAnhLc7idYRpHqyTY4EE3i8HlV12SsaUT0",
            authDomain: "viaggiogrecia2024.firebaseapp.com",
            projectId: "viaggiogrecia2024",
            storageBucket: "viaggiogrecia2024.appspot.com",
            messagingSenderId: "953454824201",
            appId: "1:953454824201:web:4f70e39ad68654892561d8"
        };

        // --- INIZIALIZZAZIONE ---
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const tripId = 'greek-islands-2024';
        const tripDocRef = db.collection('trips').doc(tripId);

        // --- STATO GLOBALE ---
        let isUpdating = false;
        let saveTimeout = null;
        
        // --- ELEMENTI DOM ---
        const connectionStatusEl = document.getElementById('connectionStatus');
        const lastUpdateEl = document.getElementById('lastUpdate');

        // --- FUNZIONI DATI ---
        const updateConnectionStatus = (status, message) => {
            connectionStatusEl.className = `connection-status ${status}`;
            connectionStatusEl.textContent = message;
        };

        const saveToFirebase = async () => {
            if (isUpdating) return;
            updateConnectionStatus('saving', '💾 Salvataggio...');
            
            const activities = {};
            const accommodations = {};
            
            document.querySelectorAll('.day-card').forEach(card => {
                const day = card.dataset.day;
                const activityInput = card.querySelector('.activity-input');
                const nameInput = card.querySelector('.bnb-name-input');
                const urlInput = card.querySelector('.bnb-input');
                
                if (activityInput) activities[day] = activityInput.value;
                
                if (nameInput || urlInput) {
                    accommodations[day] = {
                        name: nameInput ? nameInput.value : '',
                        url: urlInput ? urlInput.value : ''
                    };
                }
            });
            
            try {
                await tripDocRef.set({
                    activities,
                    accommodations,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                setTimeout(() => updateConnectionStatus('online', '🌐 Online'), 1000);
            } catch (error) {
                console.error("Errore salvataggio:", error);
                updateConnectionStatus('offline', '❌ Errore');
            }
        };

        const loadDataFromDoc = (doc) => {
            isUpdating = true;
            const data = doc.data();

            if (data.activities) {
                Object.entries(data.activities).forEach(([day, activity]) => {
                    const input = document.querySelector(`.day-card[data-day="${day}"] .activity-input`);
                    if (input) input.value = activity;
                });
            }

            if (data.accommodations) {
                Object.entries(data.accommodations).forEach(([day, accommodation]) => {
                    const card = document.querySelector(`.day-card[data-day="${day}"]`);
                    if (card) {
                        const nameInput = card.querySelector('.bnb-name-input');
                        const urlInput = card.querySelector('.bnb-input');
                        if (nameInput) nameInput.value = accommodation.name || '';
                        if (urlInput) urlInput.value = accommodation.url || '';
                        renderAccommodationLink(day);
                    }
                });
            }
            
            if (data.lastUpdated?.toDate) {
                lastUpdateEl.textContent = data.lastUpdated.toDate().toLocaleString('it-IT');
            }
            
            setTimeout(() => { isUpdating = false; }, 200);
        };

        const debouncedSave = () => {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(saveToFirebase, 1000);
        };

        // --- FUNZIONI UI ---
        const renderAccommodationLink = (day) => {
            const card = document.querySelector(`.day-card[data-day="${day}"]`);
            if (!card) return;

            const linkContainer = card.querySelector('.bnb-link-container');
            const nameInput = card.querySelector('.bnb-name-input');
            const urlInput = card.querySelector('.bnb-input');
            if (!linkContainer || !nameInput || !urlInput) return;

            const name = nameInput.value.trim();
            let url = urlInput.value.trim();
            
            if (url && !url.startsWith('http')) {
                url = `https://${url}`;
            }

            if (name && url) {
                linkContainer.innerHTML = `<a href="${url}" target="_blank" class="bnb-link">🏠 Vedi ${name}</a>`;
            } else {
                linkContainer.innerHTML = '';
            }
        };

        const showIsland = (island, btn) => {
            document.querySelectorAll('.day-card').forEach(card => card.classList.toggle('hidden', island !== 'all' && card.dataset.island !== island));
            document.querySelectorAll('.island-btn').forEach(b => b.classList.remove('active'));
            if (btn) btn.classList.add('active');
        };

        const shareWhatsApp = () => window.open(`https://wa.me/?text=${encodeURIComponent(`🇬🇷 Itinerario Isole Greche 2024!\nCollabora qui: ${window.location.href}`)}`, '_blank');
        const shareEmail = () => window.open(`mailto:?subject=${encodeURIComponent("Viaggio Isole Greche 2024")}&body=${encodeURIComponent(`Ciao! Ecco il nostro itinerario per le isole greche. Puoi modificarlo qui: ${window.location.href}`)}`);
        const copyLink = () => navigator.clipboard.writeText(window.location.href).then(() => alert('Link copiato!')).catch(() => alert('Errore copia link.'));

        // --- EVENT LISTENER ---
        document.addEventListener('DOMContentLoaded', () => {
            updateConnectionStatus('saving', '📥 Caricamento...');

            tripDocRef.onSnapshot(doc => {
                if (doc.exists) {
                    loadDataFromDoc(doc);
                    updateConnectionStatus('online', '🌐 Online');
                } else {
                    updateConnectionStatus('online', '💡 Pronto per iniziare!');
                    lastUpdateEl.textContent = 'Nessun dato salvato.';
                }
            }, error => {
                console.error("Errore listener:", error);
                updateConnectionStatus('offline', '❌ Offline');
            });

            document.querySelectorAll('.activity-input').forEach(input => input.addEventListener('input', debouncedSave));

            document.querySelectorAll('.bnb-name-input, .bnb-input').forEach(input => {
                input.addEventListener('input', () => {
                    const day = input.closest('.day-card').dataset.day;
                    renderAccommodationLink(day);
                    debouncedSave();
                });
            });
            
            window.addEventListener('online', () => updateConnectionStatus('online', '🌐 Online'));
            window.addEventListener('offline', () => updateConnectionStatus('offline', '📴 Offline'));
        });
    </script>
</body>
</html>

