
<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Viaggio Isole Greche 2024 - Mykonos, Paros, Naxos</title>
    <style>
        :root {
            --primary-light: #667eea;
            --primary-dark: #764ba2;
            --accent-blue: #4facfe;
            --accent-pink: #ff9a9e;
            --text-dark: #333;
            --text-light: #fff;
            --bg-light: rgba(255, 255, 255, 0.95);
            --border-color: #e0e0e0;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Arial', sans-serif; background: linear-gradient(135deg, var(--primary-light) 0%, var(--primary-dark) 100%); min-height: 100vh; padding: 20px; color: var(--text-dark); }
        .container { max-width: 1200px; margin: 0 auto; background: var(--bg-light); border-radius: 20px; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1); overflow: hidden; }
        .header { background: linear-gradient(135deg, var(--accent-blue) 0%, #00f2fe 100%); color: var(--text-light); padding: 30px; text-align: center; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .header p { font-size: 1.2em; }
        .connection-status { position: fixed; top: 20px; right: 20px; background: rgba(40, 167, 69, 0.9); color: var(--text-light); padding: 10px 15px; border-radius: 20px; font-size: 0.9em; z-index: 1000; transition: all 0.3s ease; }
        .connection-status.saving { background: rgba(255, 193, 7, 0.9); }
        .connection-status.offline { background: rgba(220, 53, 69, 0.9); }
        
        /* === Sezione Budget Dinamico - Stili Aggiornati === */
        .budget-section { padding: 30px; background: #fdfbfb; margin: 20px; border-radius: 15px; }
        .budget-title { text-align: center; font-size: 1.8em; color: var(--text-dark); margin-bottom: 25px; }
        .budget-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .budget-item { background: var(--text-light); border-radius: 12px; padding: 20px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 8px 25px rgba(0,0,0,0.05); transition: transform 0.2s ease-in-out; }
        .budget-item:hover { transform: translateY(-3px); }
        .budget-item-label { font-size: 1.1em; font-weight: bold; display: flex; align-items: center; gap: 12px; }
        .cost-input-wrapper { display: flex; align-items: center; background: #f0f2f5; padding: 8px 12px; border-radius: 8px; }
        .cost-input { font-family: 'Arial', sans-serif; font-size: 1.2em; font-weight: bold; color: var(--primary-dark); border: none; background: transparent; width: 100px; text-align: right; outline: none; -moz-appearance: textfield; }
        .cost-input::-webkit-outer-spin-button, .cost-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .currency-symbol { font-size: 1.2em; font-weight: bold; color: #999; margin-right: 5px; }
        .total-cost { background: var(--text-dark); color: var(--text-light); padding: 20px; border-radius: 10px; text-align: center; margin-top: 30px; font-size: 1.5em; letter-spacing: 1px; }
        
        .itinerary-section { padding: 30px; }
        .itinerary-title { text-align: center; font-size: 1.8em; margin-bottom: 30px; }
        .day-card { background: var(--text-light); border-radius: 15px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08); margin-bottom: 20px; overflow: hidden; }
        .day-card.hidden { display: none; }
        .day-header { background: linear-gradient(135deg, var(--primary-light) 0%, var(--primary-dark) 100%); color: var(--text-light); padding: 20px; display: flex; justify-content: space-between; align-items: center; }
        .day-date { font-size: 1.3em; font-weight: bold; }
        .day-location { background: rgba(255, 255, 255, 0.2); padding: 8px 16px; border-radius: 20px; }
        .day-content { padding: 25px; }
        .activity-input { width: 100%; padding: 15px; border: 2px solid var(--border-color); border-radius: 10px; font-size: 1em; margin-bottom: 15px; resize: vertical; min-height: 80px; }
        .bnb-section { background: #f8f9fa; padding: 20px; border-radius: 10px; margin-top: 15px; }
        .bnb-title { font-size: 1.1em; margin-bottom: 10px; }
        .bnb-input, .bnb-name-input { width: 100%; padding: 10px; border: 2px solid var(--border-color); border-radius: 8px; margin-bottom: 10px; }
        .bnb-link-container { margin-top: 10px; }
        .bnb-link { display: inline-block; background: var(--accent-blue); color: var(--text-light); padding: 8px 16px; border-radius: 20px; text-decoration: none; font-weight: bold; transition: background 0.3s ease; }
        .bnb-link:hover { background: #369bff; }
        .islands-nav { background: rgba(255, 255, 255, 0.9); padding: 20px; display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; }
        .island-btn { background: linear-gradient(135deg, var(--accent-pink) 0%, #fecfef 100%); color: var(--text-dark); padding: 12px 24px; border: none; border-radius: 20px; cursor: pointer; font-weight: bold; }
        .island-btn.active { background: linear-gradient(135deg, var(--primary-light) 0%, var(--primary-dark) 100%); color: var(--text-light); }
        .share-section { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); padding: 30px; text-align: center; }
        .share-title { font-size: 1.5em; margin-bottom: 20px; }
        .share-buttons { display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; }
        .share-btn { background: var(--accent-blue); color: var(--text-light); padding: 12px 24px; border: none; border-radius: 25px; cursor: pointer; }
        .last-updated { text-align: center; color: #666; font-size: 0.9em; padding: 10px; }
    </style>
</head>
<body>
    <div class="connection-status" id="connectionStatus">ğŸ”„ Connessione...</div>
    
    <div class="container">
        <div class="header">
            <h1>ğŸ‡¬ğŸ‡· Viaggio Isole Greche 2024</h1>
            <p>Mykonos â€¢ Paros â€¢ Naxos</p>
        </div>

        <div class="islands-nav">
            <button class="island-btn active" onclick="showIsland('all', this)">Tutti i Giorni</button>
            <button class="island-btn" onclick="showIsland('mykonos', this)">ğŸï¸ Mykonos</button>
            <button class="island-btn" onclick="showIsland('paros', this)">ğŸŒŠ Paros</button>
            <button class="island-btn" onclick="showIsland('naxos', this)">ğŸ–ï¸ Naxos</button>
        </div>

        <div class="budget-section">
            <h2 class="budget-title">ğŸ’° Budget Dinamico</h2>
            <div class="budget-grid">
                <div class="budget-item">
                    <label class="budget-item-label" for="cost-flight">âœˆï¸ Volo A/R</label>
                    <div class="cost-input-wrapper">
                        <span class="currency-symbol">â‚¬</span>
                        <input type="number" id="cost-flight" class="cost-input" value="400.00" step="0.01">
                    </div>
                </div>
                <div class="budget-item">
                    <label class="budget-item-label" for="cost-hotel-mykonos">ğŸ¨ Hotel Mykonos (3 notti)</label>
                    <div class="cost-input-wrapper">
                        <span class="currency-symbol">â‚¬</span>
                        <input type="number" id="cost-hotel-mykonos" class="cost-input" value="269.00" step="0.01">
                    </div>
                </div>
                <div class="budget-item">
                    <label class="budget-item-label" for="cost-ferry-mp">ğŸš¢ Traghetto My-Pa</label>
                    <div class="cost-input-wrapper">
                        <span class="currency-symbol">â‚¬</span>
                        <input type="number" id="cost-ferry-mp" class="cost-input" value="52.00" step="0.01">
                    </div>
                </div>
                <div class="budget-item">
                    <label class="budget-item-label" for="cost-hotel-paros">ğŸ¨ Hotel Paros (2 notti)</label>
                    <div class="cost-input-wrapper">
                        <span class="currency-symbol">â‚¬</span>
                        <input type="number" id="cost-hotel-paros" class="cost-input" value="140.00" step="0.01">
                    </div>
                </div>
                <div class="budget-item">
                    <label class="budget-item-label" for="cost-ferry-pn">ğŸš¢ Traghetto Pa-Na</label>
                    <div class="cost-input-wrapper">
                        <span class="currency-symbol">â‚¬</span>
                        <input type="number" id="cost-ferry-pn" class="cost-input" value="21.00" step="0.01">
                    </div>
                </div>
                 <div class="budget-item">
                    <label class="budget-item-label" for="cost-hotel-naxos">ğŸ¨ Hotel Naxos (2 notti)</label>
                    <div class="cost-input-wrapper">
                        <span class="currency-symbol">â‚¬</span>
                        <input type="number" id="cost-hotel-naxos" class="cost-input" value="145.33" step="0.01">
                    </div>
                </div>
                <div class="budget-item">
                    <label class="budget-item-label" for="cost-ferry-nm">ğŸš¢ Traghetto Na-My</label>
                    <div class="cost-input-wrapper">
                        <span class="currency-symbol">â‚¬</span>
                        <input type="number" id="cost-ferry-nm" class="cost-input" value="36.00" step="0.01">
                    </div>
                </div>
                <div class="budget-item">
                    <label class="budget-item-label" for="cost-extra">ğŸš• Trasporti & Extra</label>
                    <div class="cost-input-wrapper">
                        <span class="currency-symbol">â‚¬</span>
                        <input type="number" id="cost-extra" class="cost-input" value="100.00" step="0.01">
                    </div>
                </div>
            </div>
            <div class="total-cost" id="total-cost">
                Totale: â‚¬1163.33
            </div>
        </div>


        <div class="itinerary-section">
            <h2 class="itinerary-title">ğŸ“… Itinerario Collaborativo</h2>
            
            <div class="day-card" data-island="mykonos" data-day="2024-08-02">
                <div class="day-header"><div class="day-date">ğŸ—“ï¸ 2 Agosto</div><div class="day-location">Mykonos</div></div>
                <div class="day-content">
                    <textarea class="activity-input" placeholder="Descrivi le attivitÃ ..."></textarea>
                    <div class="bnb-section">
                        <div class="bnb-title">ğŸ  Alloggio Mykonos</div>
                        <input type="text" class="bnb-name-input" placeholder="Nome alloggio...">
                        <input type="url" class="bnb-input" placeholder="Link BnB o hotel...">
                        <div class="bnb-link-container"></div>
                    </div>
                </div>
            </div>
            <div class="day-card" data-island="mykonos" data-day="2024-08-03">
                <div class="day-header"><div class="day-date">ğŸ—“ï¸ 3 Agosto</div><div class="day-location">Mykonos</div></div>
                <div class="day-content"><textarea class="activity-input" placeholder="Descrivi le attivitÃ ..."></textarea></div>
            </div>
            <div class="day-card" data-island="paros" data-day="2024-08-05">
                <div class="day-header"><div class="day-date">ğŸ—“ï¸ 5 Agosto</div><div class="day-location">Paros</div></div>
                <div class="day-content">
                    <textarea class="activity-input" placeholder="Descrivi le attivitÃ ..."></textarea>
                    <div class="bnb-section">
                        <div class="bnb-title">ğŸ  Alloggio Paros</div>
                        <input type="text" class="bnb-name-input" placeholder="Nome alloggio...">
                        <input type="url" class="bnb-input" placeholder="Link BnB o hotel...">
                        <div class="bnb-link-container"></div>
                    </div>
                </div>
            </div>
            <div class="day-card" data-island="naxos" data-day="2024-08-07">
                <div class="day-header"><div class="day-date">ğŸ—“ï¸ 7 Agosto</div><div class="day-location">Naxos</div></div>
                <div class="day-content">
                    <textarea class="activity-input" placeholder="Descrivi le attivitÃ ..."></textarea>
                    <div class="bnb-section">
                        <div class="bnb-title">ğŸ  Alloggio Naxos</div>
                        <input type="text" class="bnb-name-input" placeholder="Nome alloggio...">
                        <input type="url" class="bnb-input" placeholder="Link BnB o hotel...">
                        <div class="bnb-link-container"></div>
                    </div>
                </div>
            </div>
            </div>

        <div class="last-updated">Ultimo aggiornamento: <span id="lastUpdate">...</span></div>

        <div class="share-section">
            <h2 class="share-title">ğŸ“± Condividi il Viaggio</h2>
            <div class="share-buttons">
                <button class="share-btn" onclick="shareWhatsApp()">ğŸ“± WhatsApp</button>
                <button class="share-btn" onclick="shareEmail()">ğŸ“§ Email</button>
                <button class="share-btn" onclick="copyLink()">ğŸ”— Copia Link</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        // --- CONFIGURAZIONE FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyAnhLc7idYRpHqyTY4EE3i8HlV12SsaUT0", // USA LE TUE VERE CREDENZIALI
            authDomain: "viaggiogrecia2024.firebaseapp.com",
            projectId: "viaggiogrecia2024",
            storageBucket: "viaggiogrecia2024.appspot.com",
            messagingSenderId: "953454824201",
            appId: "1:953454824201:web:4f70e39ad68654892561d8"
        };

        // --- INIZIALIZZAZIONE ---
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const tripId = 'greek-islands-2024';
        const tripDocRef = db.collection('trips').doc(tripId);

        // --- STATO GLOBALE ---
        let isUpdating = false;
        let saveTimeout = null;
        
        // --- ELEMENTI DOM ---
        const connectionStatusEl = document.getElementById('connectionStatus');
        const lastUpdateEl = document.getElementById('lastUpdate');
        const totalCostEl = document.getElementById('total-cost');
        const costInputs = document.querySelectorAll('.cost-input');

        // --- FUNZIONI DATI E LOGICA ---
        const updateConnectionStatus = (status, message) => {
            connectionStatusEl.className = `connection-status ${status}`;
            connectionStatusEl.textContent = message;
        };
        
        // === NUOVA FUNZIONE PER CALCOLARE IL TOTALE ===
        const calculateTotalCost = () => {
            let total = 0;
            costInputs.forEach(input => {
                const value = parseFloat(input.value);
                if (!isNaN(value)) {
                    total += value;
                }
            });
            totalCostEl.textContent = `Totale: â‚¬${total.toFixed(2)}`;
        };

        const saveToFirebase = async () => {
            if (isUpdating) return;
            updateConnectionStatus('saving', 'ğŸ’¾ Salvataggio...');
            
            const activities = {};
            const accommodations = {};
            const budget = {};
            
            document.querySelectorAll('.day-card').forEach(card => {
                const day = card.dataset.day;
                const activityInput = card.querySelector('.activity-input');
                const nameInput = card.querySelector('.bnb-name-input');
                const urlInput = card.querySelector('.bnb-input');
                if (activityInput) activities[day] = activityInput.value;
                if (nameInput || urlInput) {
                    accommodations[day] = { name: nameInput?.value || '', url: urlInput?.value || '' };
                }
            });
            
            costInputs.forEach(input => {
                budget[input.id] = input.value;
            });

            try {
                await tripDocRef.set({ activities, accommodations, budget, lastUpdated: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });
                setTimeout(() => updateConnectionStatus('online', 'ğŸŒ Online'), 1000);
            } catch (error) {
                console.error("Errore salvataggio:", error);
                updateConnectionStatus('offline', 'âŒ Errore');
            }
        };

        const loadDataFromDoc = (doc) => {
            isUpdating = true;
            const data = doc.data();

            // Carica itinerario
            if (data.activities) {
                Object.entries(data.activities).forEach(([day, activity]) => {
                    const input = document.querySelector(`.day-card[data-day="${day}"] .activity-input`);
                    if (input) input.value = activity;
                });
            }

            // Carica alloggi
            if (data.accommodations) {
                Object.entries(data.accommodations).forEach(([day, accommodation]) => {
                    const card = document.querySelector(`.day-card[data-day="${day}"]`);
                    if (card) {
                        const nameInput = card.querySelector('.bnb-name-input');
                        const urlInput = card.querySelector('.bnb-input');
                        if (nameInput) nameInput.value = accommodation.name || '';
                        if (urlInput) urlInput.value = accommodation.url || '';
                        renderAccommodationLink(day);
                    }
                });
            }

            // Carica budget
            if (data.budget) {
                Object.entries(data.budget).forEach(([id, value]) => {
                    const input = document.getElementById(id);
                    if (input) input.value = value;
                });
            }
            calculateTotalCost(); // Ricalcola il totale con i dati caricati
            
            if (data.lastUpdated?.toDate) {
                lastUpdateEl.textContent = data.lastUpdated.toDate().toLocaleString('it-IT');
            }
            
            setTimeout(() => { isUpdating = false; }, 200);
        };

        const debouncedSave = () => {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(saveToFirebase, 1000);
        };

        // --- FUNZIONI UI ---
        const renderAccommodationLink = (day) => {
            const card = document.querySelector(`.day-card[data-day="${day}"]`);
            if (!card) return;
            const linkContainer = card.querySelector('.bnb-link-container');
            const nameInput = card.querySelector('.bnb-name-input');
            const urlInput = card.querySelector('.bnb-input');
            if (!linkContainer || !nameInput || !urlInput) return;
            const name = nameInput.value.trim();
            let url = urlInput.value.trim();
            if (url && !url.startsWith('http')) url = `https://${url}`;
            if (name && url) {
                linkContainer.innerHTML = `<a href="${url}" target="_blank" class="bnb-link">ğŸ  Vedi ${name}</a>`;
            } else {
                linkContainer.innerHTML = '';
            }
        };
        const showIsland = (island, btn) => {
            document.querySelectorAll('.day-card').forEach(card => card.classList.toggle('hidden', island !== 'all' && card.dataset.island !== island));
            document.querySelectorAll('.island-btn').forEach(b => b.classList.remove('active'));
            if (btn) btn.classList.add('active');
        };
        const shareWhatsApp = () => window.open(`https://wa.me/?text=${encodeURIComponent(`ğŸ‡¬ğŸ‡· Itinerario Isole Greche 2024!\nCollabora qui: ${window.location.href}`)}`, '_blank');
        const shareEmail = () => window.open(`mailto:?subject=${encodeURIComponent("Viaggio Isole Greche 2024")}&body=${encodeURIComponent(`Ciao! Ecco il nostro itinerario. Puoi modificarlo qui: ${window.location.href}`)}`);
        const copyLink = () => navigator.clipboard.writeText(window.location.href).then(() => alert('Link copiato!')).catch(() => alert('Errore copia link.'));

        // --- EVENT LISTENER ALL'AVVIO ---
        document.addEventListener('DOMContentLoaded', () => {
            updateConnectionStatus('saving', 'ğŸ“¥ Caricamento...');

            // Listener per il budget
            costInputs.forEach(input => {
                input.addEventListener('input', () => {
                    calculateTotalCost();
                    debouncedSave();
                });
            });

            // Listener per i dati da Firebase
            tripDocRef.onSnapshot(doc => {
                if (doc.exists) {
                    loadDataFromDoc(doc);
                    updateConnectionStatus('online', 'ğŸŒ Online');
                } else {
                    calculateTotalCost(); // Calcola il totale iniziale anche se non ci sono dati
                    updateConnectionStatus('online', 'ğŸ’¡ Pronto per iniziare!');
                }
            }, error => {
                console.error("Errore listener:", error);
                updateConnectionStatus('offline', 'âŒ Offline');
            });

            // Listener per itinerario e alloggi
            document.querySelectorAll('.activity-input, .bnb-name-input, .bnb-input').forEach(input => {
                input.addEventListener('input', () => {
                    if(input.classList.contains('bnb-name-input') || input.classList.contains('bnb-input')) {
                        const day = input.closest('.day-card').dataset.day;
                        renderAccommodationLink(day);
                    }
                    debouncedSave();
                });
            });
            
            window.addEventListener('online', () => updateConnectionStatus('online', 'ğŸŒ Online'));
            window.addEventListener('offline', () => updateConnectionStatus('offline', 'ğŸ“´ Offline'));
        });
    </script>
</body>
</html>
